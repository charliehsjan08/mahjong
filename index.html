<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éº»è¨ˆåˆ†æ¿ (å­˜æª”ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2E7D32;
            --dealer-color: #d32f2f;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #fff;
            --win-color: #388E3C;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* é ‚éƒ¨å°èˆªåˆ— */
        .nav-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; background: white; padding: 10px;
            border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-title { font-weight: bold; color: var(--primary-color); font-size: 1.1em; }
        .game-id { font-size: 0.8em; color: #888; margin-top: 2px;}
        .btn-menu {
            background: #f0f0f0; border: none; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9em;
        }

        /* å€å¡Šæ¨£å¼ */
        .section-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
        }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { display: block; font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 1em; background: white;
        }

        /* ç©å®¶å¡ç‰‡ */
        .players-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .player-card {
            background: var(--card-bg); padding: 10px; border-radius: 10px;
            text-align: center; border-left: 5px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;
            display: flex; flex-direction: column; justify-content: center;
        }
        .player-card.is-dealer { border-left-color: var(--dealer-color); background-color: #fff5f5; }
        
        .dealer-badge {
            position: absolute; top: 8px; left: 8px; width: 24px; height: 24px;
            line-height: 24px; border-radius: 50%; background: #eee; color: #aaa;
            font-weight: bold; cursor: pointer; font-size: 0.8em;
        }
        .player-card.is-dealer .dealer-badge { background: var(--dealer-color); color: white; }

        .lien-control {
            display: none; justify-content: center; align-items: center; gap: 5px;
            margin-top: 5px; font-weight: bold; color: var(--dealer-color);
        }
        .player-card.is-dealer .lien-control { display: flex; }

        .btn-mini {
            width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--dealer-color);
            background: white; color: var(--dealer-color); font-size: 1.1em;
            line-height: 20px; cursor: pointer; padding: 0;
        }

        .player-name-input {
            text-align:center; border:none; background:transparent; 
            font-weight:bold; font-size:1.1em; width:100%; margin-top: 15px; margin-bottom: 2px;
        }
        .player-score { font-size: 1.5em; font-family: monospace; font-weight: bold; margin-top: 5px;}
        .score-positive { color: var(--win-color); }
        .score-negative { color: var(--dealer-color); }

        /* æ“ä½œæŒ‰éˆ• */
        .action-form { display: flex; flex-direction: column; gap: 15px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-type {
            flex: 1; padding: 10px; border: 2px solid var(--primary-color);
            background: transparent; color: var(--primary-color); border-radius: 8px;
            font-weight: bold; cursor: pointer;
        }
        .btn-type.active { background: var(--primary-color); color: white; }
        
        .btn-adjust {
            width: 45px; border: 1px solid #ccc; background: #fff;
            color: var(--primary-color); border-radius: 8px; font-size: 1.5em;
            display: flex; justify-content: center; align-items: center; padding: 0;
        }

        .btn-submit {
            width: 100%; padding: 15px; background: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold;
            box-shadow: 0 4px 6px rgba(46, 125, 50, 0.3); cursor: pointer;
        }
        .btn-submit:active { transform: scale(0.98); }

        .history-list { list-style: none; padding: 0; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .history-item {
            background: #fff; padding: 10px; border-bottom: 1px solid #eee;
            font-size: 0.9em; display: flex; justify-content: space-between;
        }
        .history-details { color: #666; font-size: 0.8em; }

        /* Modal é€šç”¨ */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px;
        }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        /* æˆ°å±€åˆ—è¡¨æ¨£å¼ */
        .session-list { list-style: none; padding: 0; }
        .session-item {
            padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .session-info { flex: 1; }
        .session-title { font-weight: bold; display: block; }
        .session-date { font-size: 0.8em; color: #888; }
        .btn-load { background: var(--primary-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;}
        .btn-del { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;}
        
        /* Table */
        .tai-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tai-table th, .tai-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .tai-badge { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.85em; }
        .category-header { background-color: #f9f9f9; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div>
            <div class="nav-title" id="displayGameName">æœªå‘½åæˆ°å±€</div>
            <div class="game-id">ID: <span id="displayGameId">---</span></div>
        </div>
        <button class="btn-menu" onclick="openSessionModal()">ğŸ—‚ï¸ æˆ°å±€é¸å–®</button>
    </div>

    <div class="section-card">
        <div class="settings-grid">
            <div>
                <label>åº• (Base)</label>
                <input type="number" id="baseValue" value="30" inputmode="numeric" onchange="autoSave()">
            </div>
            <div>
                <label>å° (Tai)</label>
                <input type="number" id="taiValue" value="10" inputmode="numeric" onchange="autoSave()">
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.9em;">ğŸ‘‡ é»æ“Šåå­—å·¦ä¸Šã€ŒèŠã€è¨­èŠå®¶</div>
    <div class="players-grid" id="playersContainer"></div>

    <div class="section-card">
        <div class="action-form">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;">
                    <label>è´å®¶</label>
                    <select id="winnerSelect"></select>
                </div>
                <div style="flex:1;" id="loserContainer">
                    <label>æ”¾æ§è€…</label>
                    <select id="loserSelect"></select>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-type active" onclick="setWinType('discard')">èƒ¡ç‰Œ (æ”¾æ§)</button>
                <button class="btn-type" onclick="setWinType('selfdraw')">è‡ªæ‘¸</button>
            </div>

            <div>
                <label>å°æ•¸</label>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-adjust" onclick="modifyTai(-1)">-</button>
                    <input type="number" id="taiCount" placeholder="0" inputmode="numeric" style="flex: 1; text-align:center;">
                    <button class="btn-adjust" onclick="modifyTai(1)">+</button>
                    <button class="btn-type" style="flex:0 0 auto; width:50px; background:#607D8B; color:white; border:none; padding:0;" onclick="openTaiModal()">ğŸ“–</button>
                </div>
                <small style="color:#d32f2f; font-weight:bold; display:block; margin-top:5px;" id="dealerRuleText"></small>
            </div>

            <button class="btn-submit" onclick="calculateScore()">çµç®— (Calculate)</button>
        </div>
    </div>

    <div class="section-card">
        <label>æ­·å²ç´€éŒ„</label>
        <ul class="history-list" id="historyList"></ul>
    </div>

    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSessionModal()">&times;</span>
            <h2 style="margin-top:0;">æˆ°å±€ç®¡ç†</h2>
            
            <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <label>ç•¶å‰æˆ°å±€åç¨±</label>
                <input type="text" id="gameNameInput" placeholder="ä¾‹å¦‚ï¼šé€±äº”é€šå®µå ´" onchange="updateGameName()">
                <div style="margin-top: 10px; display:flex; gap:10px;">
                    <button class="btn-type active" onclick="startNewGame()">é–‹æ–°æˆ°å±€</button>
                    <button class="btn-type" onclick="manualSave()">æ‰‹å‹•å„²å­˜</button>
                </div>
            </div>

            <label>å·²å„²å­˜çš„æˆ°å±€ (é»æ“Šè¼‰å…¥)</label>
            <ul class="session-list" id="sessionList">
                </ul>
        </div>
    </div>

    <div id="taiModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeTaiModal()">&times;</span>
            <h2 style="margin-top:0;">å°æ•¸è¡¨</h2>
            <table class="tai-table">
                <tr class="category-header"><td colspan="2">åŸºæœ¬</td></tr>
                <tr onclick="addTaiToInput(1)"><td>è‡ªæ‘¸ / é–€æ¸…</td><td><span class="tai-badge">1</span></td></tr>
                <tr onclick="addTaiToInput(1)"><td>é¢¨ç‰Œ / ç®­ç‰Œ / èŠ±ç‰Œ</td><td><span class="tai-badge">1</span></td></tr>
                <tr class="category-header"><td colspan="2">å¸¸è¦‹ç‰Œå‹</td></tr>
                <tr onclick="addTaiToInput(2)"><td>å¹³èƒ¡ / ä¸‰æš—åˆ»</td><td><span class="tai-badge">2</span></td></tr>
                <tr onclick="addTaiToInput(4)"><td>ç¢°ç¢°èƒ¡ / æ··ä¸€è‰²</td><td><span class="tai-badge">4</span></td></tr>
                <tr class="category-header"><td colspan="2">å¤§ç‰Œ</td></tr>
                <tr onclick="addTaiToInput(8)"><td>æ¸…ä¸€è‰² / äº”æš—åˆ»</td><td><span class="tai-badge">8</span></td></tr>
                <tr onclick="addTaiToInput(16)"><td>å¤§å››å–œ / å­—ä¸€è‰²</td><td><span class="tai-badge">16</span></td></tr>
            </table>
        </div>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let players = [ { name: "æ±", score: 0 }, { name: "å—", score: 0 }, { name: "è¥¿", score: 0 }, { name: "åŒ—", score: 0 } ];
    let dealerIndex = 0; 
    let lienCount = 0;   
    let currentWinType = 'discard';
    let historyLogs = []; // ç”¨ä¾†å­˜ log æ–‡å­—

    // æˆ°å±€è³‡è¨Š
    let gameId = "";
    let gameName = "æœªå‘½åæˆ°å±€";

    // --- åˆå§‹åŒ– ---
    function init() {
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€æ¬¡çš„æˆ°å±€
        const lastGameId = localStorage.getItem('mj_last_game_id');
        if (lastGameId && localStorage.getItem('mj_save_' + lastGameId)) {
            loadGame(lastGameId);
        } else {
            startNewGame();
        }

        renderPlayers();
        updateSelectOptions();
        updateDealerRuleText();
        
        // Modal é»æ“Šå¤–éƒ¨é—œé–‰
        window.onclick = function(e) { 
            if(e.target == document.getElementById('taiModal')) closeTaiModal(); 
            if(e.target == document.getElementById('sessionModal')) closeSessionModal(); 
        }
    }

    // --- æˆ°å±€ç®¡ç†ç³»çµ± (Session System) ---

    function startNewGame() {
        if(confirm("ç¢ºå®šè¦é–‹å•Ÿæ–°æˆ°å±€å—ï¼Ÿç›®å‰çš„é€²åº¦è‹¥æœªå„²å­˜å°‡æœƒè¢«è¦†è“‹(è‹¥å·²è‡ªå‹•å„²å­˜å‰‡åœ¨åˆ—è¡¨å…§)ã€‚")) {
            gameId = "GAME-" + Date.now().toString().slice(-6); // ç”¢ç”Ÿç°¡æ˜“ Seed
            gameName = "æœªå‘½åæˆ°å±€";
            players = [ { name: "æ±", score: 0 }, { name: "å—", score: 0 }, { name: "è¥¿", score: 0 }, { name: "åŒ—", score: 0 } ];
            dealerIndex = 0;
            lienCount = 0;
            historyLogs = [];
            
            document.getElementById('historyList').innerHTML = "";
            document.getElementById('gameNameInput').value = "";
            
            updateUIInfo();
            renderPlayers();
            autoSave(); // åˆå§‹å„²å­˜
            closeSessionModal();
        }
    }

    function updateGameName() {
        const input = document.getElementById('gameNameInput').value;
        if(input.trim()) {
            gameName = input;
            updateUIInfo();
            autoSave();
        }
    }

    function updateUIInfo() {
        document.getElementById('displayGameName').innerText = gameName;
        document.getElementById('displayGameId').innerText = gameId;
    }

    // è‡ªå‹•å„²å­˜åˆ° LocalStorage
    function autoSave() {
        const gameState = {
            id: gameId,
            name: gameName,
            timestamp: Date.now(),
            base: document.getElementById('baseValue').value,
            tai: document.getElementById('taiValue').value,
            players: players,
            dealerIndex: dealerIndex,
            lienCount: lienCount,
            logs: historyLogs
        };
        
        // å­˜å€‹åˆ¥æˆ°å±€
        localStorage.setItem('mj_save_' + gameId, JSON.stringify(gameState));
        // è¨˜ä½æœ€å¾Œé–‹å•Ÿçš„ ID
        localStorage.setItem('mj_last_game_id', gameId);
    }

    function manualSave() {
        autoSave();
        alert("å„²å­˜æˆåŠŸï¼");
    }

    function loadGame(id) {
        const data = localStorage.getItem('mj_save_' + id);
        if(!data) return;

        const state = JSON.parse(data);
        gameId = state.id;
        gameName = state.name;
        players = state.players;
        dealerIndex = state.dealerIndex;
        lienCount = state.lienCount;
        historyLogs = state.logs || [];

        document.getElementById('baseValue').value = state.base;
        document.getElementById('taiValue').value = state.tai;
        document.getElementById('gameNameInput').value = state.name;

        // æ¢å¾© Logs
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        historyLogs.forEach(log => {
            const item = document.createElement('li');
            item.className = 'history-item';
            item.innerHTML = log;
            list.appendChild(item);
        });

        updateUIInfo();
        renderPlayers();
        updateSelectOptions();
        updateDealerRuleText();
        localStorage.setItem('mj_last_game_id', gameId);
        
        closeSessionModal();
    }

    function deleteGame(id) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ")) {
            localStorage.removeItem('mj_save_' + id);
            renderSessionList(); // åˆ·æ–°åˆ—è¡¨
        }
    }

    function renderSessionList() {
        const list = document.getElementById('sessionList');
        list.innerHTML = "";
        
        // æœå°‹æ‰€æœ‰é–‹é ­ç‚º mj_save_ çš„ key
        let saves = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('mj_save_')) {
                try {
                    saves.push(JSON.parse(localStorage.getItem(key)));
                } catch(e) {}
            }
        }

        // ä¾æ™‚é–“æ’åº (æ–°åˆ°èˆŠ)
        saves.sort((a, b) => b.timestamp - a.timestamp);

        if(saves.length === 0) {
            list.innerHTML = "<li style='color:#999; text-align:center;'>å°šç„¡ç´€éŒ„</li>";
            return;
        }

        saves.forEach(save => {
            const dateStr = new Date(save.timestamp).toLocaleString();
            const activeClass = (save.id === gameId) ? "color:var(--primary-color);" : "";
            const item = document.createElement('li');
            item.className = 'session-item';
            item.innerHTML = `
                <div class="session-info">
                    <span class="session-title" style="${activeClass}">${save.name || 'æœªå‘½å'}</span>
                    <span class="session-date">${dateStr} (ID:${save.id})</span>
                </div>
                <div>
                    <button class="btn-load" onclick="loadGame('${save.id}')">è®€å–</button>
                    <button class="btn-del" onclick="deleteGame('${save.id}')">åˆª</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // --- Modal æ§åˆ¶ ---
    function openSessionModal() { 
        document.getElementById('sessionModal').style.display = "block"; 
        renderSessionList();
    }
    function closeSessionModal() { document.getElementById('sessionModal').style.display = "none"; }
    
    function openTaiModal() { document.getElementById('taiModal').style.display = "block"; }
    function closeTaiModal() { document.getElementById('taiModal').style.display = "none"; }

    // --- éŠæˆ²é‚è¼¯ ---

    function setDealer(index) {
        if (dealerIndex !== index) {
            dealerIndex = index;
            lienCount = 0;
            renderPlayers();
            updateSelectOptions();
            autoSave();
        }
    }

    function modifyLien(delta) {
        lienCount += delta;
        if (lienCount < 0) lienCount = 0;
        renderPlayers();
        updateDealerRuleText();
        autoSave();
    }

    function modifyTai(delta) {
        const input = document.getElementById('taiCount');
        let val = parseInt(input.value) || 0;
        val += delta;
        if(val < 0) val = 0;
        input.value = val;
    }

    function renderPlayers() {
        const container = document.getElementById('playersContainer');
        container.innerHTML = '';
        players.forEach((p, index) => {
            let scoreClass = p.score >= 0 ? 'score-positive' : 'score-negative';
            let isDealer = (index === dealerIndex) ? 'is-dealer' : '';
            
            let lienHtml = '';
            if (index === dealerIndex) {
                lienHtml = `
                <div class="lien-control">
                    <button class="btn-mini" onclick="modifyLien(-1)">-</button>
                    <span>é€£ ${lienCount}</span>
                    <button class="btn-mini" onclick="modifyLien(1)">+</button>
                </div>`;
            } else {
                lienHtml = `<div style="height: 29px;"></div>`; 
            }

            container.innerHTML += `
                <div class="player-card ${isDealer}">
                    <div class="dealer-badge" onclick="setDealer(${index})">èŠ</div>
                    <input type="text" class="player-name-input" value="${p.name}" 
                           onchange="updateName(${index}, this.value)">
                    ${lienHtml}
                    <div class="player-score ${scoreClass}">${p.score}</div>
                </div>`;
        });
    }

    function updateName(index, newName) { 
        players[index].name = newName; 
        updateSelectOptions();
        autoSave();
    }

    function updateSelectOptions() {
        const winnerSelect = document.getElementById('winnerSelect');
        const loserSelect = document.getElementById('loserSelect');
        const oldWin = winnerSelect.value;
        const oldLose = loserSelect.value;
        
        winnerSelect.innerHTML = ''; loserSelect.innerHTML = '';
        players.forEach((p, index) => {
            let txt = p.name + (index === dealerIndex ? " (èŠ)" : "");
            let option = `<option value="${index}">${txt}</option>`;
            winnerSelect.innerHTML += option;
            loserSelect.innerHTML += option;
        });
        if(oldWin) winnerSelect.value = oldWin;
        if(oldLose) loserSelect.value = oldLose;
        
        updateDealerRuleText();
    }

    function setWinType(type) {
        currentWinType = type;
        document.querySelectorAll('.btn-type')[0].classList.toggle('active', type === 'discard');
        document.querySelectorAll('.btn-type')[1].classList.toggle('active', type === 'selfdraw');
        document.getElementById('loserContainer').style.visibility = (type === 'discard') ? 'visible' : 'hidden';
        updateDealerRuleText();
    }

    function updateDealerRuleText() {
        const txt = document.getElementById('dealerRuleText');
        const dealerExtra = 1 + (2 * lienCount);
        const dealerName = players[dealerIndex].name;
        
        let msg = "";
        if (currentWinType === 'selfdraw') {
            msg = `æç¤ºï¼šè‹¥é–’å®¶è‡ªæ‘¸ï¼Œ${dealerName} å¤šä»˜ ${dealerExtra} å°ï¼›è‹¥ ${dealerName} è‡ªæ‘¸ï¼Œä¸‰å®¶å¤šä»˜ ${dealerExtra} å°ã€‚`;
        } else {
            msg = `æç¤ºï¼šè‹¥ ${dealerName} èƒ¡ç‰Œæˆ–æ”¾æ§ï¼Œè‡ªå‹•å¤šç®— ${dealerExtra} å° (èŠ1+é€£${lienCount*2})ã€‚`;
        }
        txt.innerText = msg;
    }

    function calculateScore() {
        const base = parseInt(document.getElementById('baseValue').value) || 0;
        const taiValue = parseInt(document.getElementById('taiValue').value) || 0;
        const inputTai = parseInt(document.getElementById('taiCount').value);
        const winnerIdx = parseInt(document.getElementById('winnerSelect').value);
        
        if (isNaN(inputTai)) { alert("è«‹è¼¸å…¥å°æ•¸ï¼"); return; }

        let logText = "";
        let logHtml = "";
        let totalWinAmount = 0;
        let confirmMsg = "";
        
        const dealerExtraTai = 1 + (2 * lienCount);

        const calculatePayment = (tai, isDealerInvolved) => {
            let finalTai = isDealerInvolved ? (tai + dealerExtraTai) : tai;
            return base + (finalTai * taiValue);
        };

        if (currentWinType === 'discard') {
            const loserIdx = parseInt(document.getElementById('loserSelect').value);
            if (winnerIdx === loserIdx) { alert("è´å®¶èˆ‡è¼¸å®¶ä¸èƒ½åŒä¸€äºº"); return; }

            let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
            let amount = calculatePayment(inputTai, isDealerInvolved);

            confirmMsg = `ã€èƒ¡ç‰Œçµç®—ã€‘\n\nè´å®¶ï¼š${players[winnerIdx].name}\næ”¾æ§ï¼š${players[loserIdx].name}\nå°æ•¸ï¼š${inputTai} å°`;
            if (isDealerInvolved) confirmMsg += ` (+èŠé€£${lienCount})`;
            confirmMsg += `\n\nğŸ’° é‡‘é¡ï¼š$${amount}`;
            
            if(!confirm(confirmMsg)) return;

            players[winnerIdx].score += amount;
            players[loserIdx].score -= amount;

            let extraText = isDealerInvolved ? ` (å«èŠé€£${lienCount})` : "";
            logText = `${players[winnerIdx].name} èƒ¡ ${players[loserIdx].name} - ${inputTai}å°${extraText}: ${amount}`;

        } else {
            let detailLog = [];
            confirmMsg = `ã€è‡ªæ‘¸çµç®—ã€‘\n\nè´å®¶ï¼š${players[winnerIdx].name}\nå°æ•¸ï¼š${inputTai} å°\n\n`;

            let tempTotalWin = 0;
            players.forEach((p, loserIdx) => {
                if (loserIdx === winnerIdx) return;
                let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
                let amount = calculatePayment(inputTai, isDealerInvolved);
                tempTotalWin += amount;
                confirmMsg += `${p.name} ä»˜ï¼š$${amount}`;
                if (isDealerInvolved) confirmMsg += ` (å«èŠ)`;
                confirmMsg += `\n`;
            });
            confirmMsg += `\nğŸ’° ç¸½æ”¶ï¼š$${tempTotalWin}`;

            if(!confirm(confirmMsg)) return;

            players.forEach((p, loserIdx) => {
                if (loserIdx === winnerIdx) return;
                let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
                let amount = calculatePayment(inputTai, isDealerInvolved);
                p.score -= amount;
                totalWinAmount += amount;
                if(isDealerInvolved) detailLog.push("èŠ");
            });

            players[winnerIdx].score += totalWinAmount;
            let extraText = (detailLog.length > 0) ? ` (å«èŠé€£${lienCount})` : "";
            logText = `${players[winnerIdx].name} è‡ªæ‘¸ ${inputTai}å°${extraText}, ç¸½æ”¶: ${totalWinAmount}`;
        }

        if (navigator.vibrate) navigator.vibrate(50);

        renderPlayers();
        
        // ç´€éŒ„ Log
        logHtml = `<span>${logText}</span> <span class="history-details">${new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})}</span>`;
        historyLogs.unshift(logHtml); // å­˜å…¥é™£åˆ—
        
        const list = document.getElementById('historyList');
        const item = document.createElement('li');
        item.className = 'history-item';
        item.innerHTML = logHtml;
        list.insertBefore(item, list.firstChild);

        document.getElementById('taiCount').value = '';
        autoSave(); // çµç®—å¾Œè‡ªå‹•å­˜æª”
    }

    function addTaiToInput(t) { 
        let inp = document.getElementById('taiCount'); 
        inp.value = (parseInt(inp.value)||0) + t; 
    }

    init();
</script>

</body>
</html>
