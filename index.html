<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éº»è¨ˆåˆ†æ¿ Pro</title>
    <style>
        :root {
            --primary-color: #2E7D32;
            --dealer-color: #d32f2f; /* èŠå®¶ç´… */
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #fff;
            --win-color: #388E3C;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }

        .section-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        label { display: block; font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        
        input[type="number"], input[type="text"], select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 1em; background: white;
        }

        /* ç©å®¶å€åŸŸ */
        .players-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        
        .player-card {
            background: var(--card-bg); padding: 10px; border-radius: 10px;
            text-align: center; border-left: 5px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.3s;
            display: flex; flex-direction: column; justify-content: center;
        }

        /* èŠå®¶æ¨£å¼ */
        .player-card.is-dealer {
            border-left: 5px solid var(--dealer-color);
            background-color: #fff5f5;
        }

        /* èŠå®¶æŒ‰éˆ• */
        .dealer-badge {
            position: absolute; top: 8px; left: 8px;
            width: 24px; height: 24px; line-height: 24px;
            border-radius: 50%; background: #eee; color: #aaa;
            font-weight: bold; cursor: pointer; font-size: 0.8em;
            border: 2px solid transparent;
        }
        
        .player-card.is-dealer .dealer-badge {
            background: var(--dealer-color); color: white;
            box-shadow: 0 2px 4px rgba(211, 47, 47, 0.4);
        }

        /* é€£èŠæ§åˆ¶å™¨ */
        .lien-control {
            display: none; /* é è¨­éš±è— */
            justify-content: center; align-items: center; gap: 5px;
            margin-top: 5px; font-weight: bold; color: var(--dealer-color);
        }
        .player-card.is-dealer .lien-control { display: flex; } /* èŠå®¶æ‰é¡¯ç¤º */

        .btn-mini {
            width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--dealer-color);
            background: white; color: var(--dealer-color); font-size: 1.1em; line-height: 20px;
            cursor: pointer; padding: 0;
        }

        /* åˆ†æ•¸èˆ‡åå­— */
        .player-name-input {
            text-align:center; border:none; background:transparent; 
            font-weight:bold; font-size:1.1em; width:100%; margin-top: 15px; margin-bottom: 2px;
            padding: 2px;
        }
        .player-name-input:focus { border-bottom: 1px solid #999; outline: none; }

        .player-score { font-size: 1.5em; font-family: monospace; font-weight: bold; margin-top: 5px;}
        .score-positive { color: var(--win-color); }
        .score-negative { color: var(--dealer-color); }

        .action-form { display: flex; flex-direction: column; gap: 15px; }

        .btn-group { display: flex; gap: 10px; }
        
        .btn-type {
            flex: 1; padding: 10px; border: 2px solid var(--primary-color);
            background: transparent; color: var(--primary-color); border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        .btn-type.active { background: var(--primary-color); color: white; }

        .btn-submit {
            width: 100%; padding: 15px; background: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 6px rgba(46, 125, 50, 0.3);
        }
        .btn-submit:active { transform: scale(0.98); }

        .history-list { list-style: none; padding: 0; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .history-item {
            background: #fff; padding: 10px; border-bottom: 1px solid #eee;
            font-size: 0.9em; display: flex; justify-content: space-between;
        }
        .history-details { color: #666; font-size: 0.8em; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: 12px;
        }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* Table */
        .tai-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tai-table th, .tai-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .tai-badge { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.85em; }
        .category-header { background-color: #f9f9f9; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <h1>ğŸ€„ å°éº»è¨ˆåˆ†æ¿</h1>

    <div class="section-card">
        <div class="settings-grid">
            <div>
                <label>åº• (Base)</label>
                <input type="number" id="baseValue" value="30" inputmode="numeric">
            </div>
            <div>
                <label>å° (Tai)</label>
                <input type="number" id="taiValue" value="10" inputmode="numeric">
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.9em;">ğŸ‘‡ é»æ“Šåå­—å·¦ä¸Šã€ŒèŠã€è¨­èŠå®¶ï¼Œåå­—ç›´æ¥é»æ“Šå¯ä¿®æ”¹</div>
    <div class="players-grid" id="playersContainer"></div>

    <div class="section-card">
        <div class="action-form">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;">
                    <label>è´å®¶</label>
                    <select id="winnerSelect"></select>
                </div>
                <div style="flex:1;" id="loserContainer">
                    <label>æ”¾æ§è€…</label>
                    <select id="loserSelect"></select>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-type active" onclick="setWinType('discard')">èƒ¡ç‰Œ (æ”¾æ§)</button>
                <button class="btn-type" onclick="setWinType('selfdraw')">è‡ªæ‘¸</button>
            </div>

            <div>
                <label>å°æ•¸ (è¼¸å…¥ç‰Œå‹å°æ•¸å³å¯)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="taiCount" placeholder="0" inputmode="numeric" style="flex: 1;">
                    <button class="btn-type" style="flex:0 0 auto; background:#607D8B; color:white; border:none;" onclick="openModal()">ğŸ“– è¡¨</button>
                </div>
                <small style="color:#d32f2f; font-weight:bold; display:block; margin-top:5px;" id="dealerRuleText"></small>
            </div>

            <button class="btn-submit" onclick="calculateScore()">çµç®— (Calculate)</button>
        </div>
    </div>

    <div class="section-card">
        <label>æ­·å²ç´€éŒ„</label>
        <ul class="history-list" id="historyList"></ul>
    </div>

    <div id="taiModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 style="margin-top:0;">å°æ•¸è¡¨</h2>
            <p style="font-size:0.9em; color:#666;">é»æ“Šå°æ•¸å¯è‡ªå‹•åŠ å…¥è¨ˆç®—</p>
            <table class="tai-table">
                <tr class="category-header"><td colspan="2">åŸºæœ¬</td></tr>
                <tr onclick="addTaiToInput(1)"><td>è‡ªæ‘¸ / é–€æ¸…</td><td><span class="tai-badge">1</span></td></tr>
                <tr onclick="addTaiToInput(1)"><td>é¢¨ç‰Œ / ç®­ç‰Œ / èŠ±ç‰Œ</td><td><span class="tai-badge">1</span></td></tr>
                <tr class="category-header"><td colspan="2">å¸¸è¦‹ç‰Œå‹</td></tr>
                <tr onclick="addTaiToInput(2)"><td>å¹³èƒ¡ / ä¸‰æš—åˆ»</td><td><span class="tai-badge">2</span></td></tr>
                <tr onclick="addTaiToInput(4)"><td>ç¢°ç¢°èƒ¡ / æ··ä¸€è‰²</td><td><span class="tai-badge">4</span></td></tr>
                <tr class="category-header"><td colspan="2">å¤§ç‰Œ</td></tr>
                <tr onclick="addTaiToInput(8)"><td>æ¸…ä¸€è‰² / äº”æš—åˆ»</td><td><span class="tai-badge">8</span></td></tr>
                <tr onclick="addTaiToInput(16)"><td>å¤§å››å–œ / å­—ä¸€è‰²</td><td><span class="tai-badge">16</span></td></tr>
            </table>
        </div>
    </div>

<script>
    // è³‡æ–™åˆå§‹
    let players = [ { name: "æ±", score: 0 }, { name: "å—", score: 0 }, { name: "è¥¿", score: 0 }, { name: "åŒ—", score: 0 } ];
    let dealerIndex = 0; 
    let lienCount = 0;   
    let currentWinType = 'discard';

    function init() {
        renderPlayers();
        updateSelectOptions();
        window.onclick = function(e) { if(e.target == document.getElementById('taiModal')) closeModal(); }
        updateDealerRuleText(); 
    }

    // è¨­å®šèŠå®¶
    function setDealer(index) {
        if (dealerIndex !== index) {
            dealerIndex = index;
            lienCount = 0;
            renderPlayers();
            updateSelectOptions();
        }
    }

    // èª¿æ•´é€£èŠæ•¸
    function modifyLien(delta) {
        lienCount += delta;
        if (lienCount < 0) lienCount = 0;
        renderPlayers();
        updateDealerRuleText();
    }

    function renderPlayers() {
        const container = document.getElementById('playersContainer');
        container.innerHTML = '';
        players.forEach((p, index) => {
            let scoreClass = p.score >= 0 ? 'score-positive' : 'score-negative';
            let isDealer = (index === dealerIndex) ? 'is-dealer' : '';
            
            let lienHtml = '';
            if (index === dealerIndex) {
                lienHtml = `
                <div class="lien-control">
                    <button class="btn-mini" onclick="modifyLien(-1)">-</button>
                    <span>é€£ ${lienCount}</span>
                    <button class="btn-mini" onclick="modifyLien(1)">+</button>
                </div>`;
            } else {
                lienHtml = `<div style="height: 29px;"></div>`; 
            }

            container.innerHTML += `
                <div class="player-card ${isDealer}">
                    <div class="dealer-badge" onclick="setDealer(${index})">èŠ</div>
                    <input type="text" class="player-name-input" value="${p.name}" 
                           onchange="updateName(${index}, this.value)">
                    ${lienHtml}
                    <div class="player-score ${scoreClass}">${p.score}</div>
                </div>`;
        });
    }

    function updateName(index, newName) { 
        players[index].name = newName; 
        updateSelectOptions();
    }

    function updateSelectOptions() {
        const winnerSelect = document.getElementById('winnerSelect');
        const loserSelect = document.getElementById('loserSelect');
        const oldWin = winnerSelect.value;
        const oldLose = loserSelect.value;
        
        winnerSelect.innerHTML = ''; loserSelect.innerHTML = '';
        players.forEach((p, index) => {
            let txt = p.name + (index === dealerIndex ? " (èŠ)" : "");
            let option = `<option value="${index}">${txt}</option>`;
            winnerSelect.innerHTML += option;
            loserSelect.innerHTML += option;
        });
        if(oldWin) winnerSelect.value = oldWin;
        if(oldLose) loserSelect.value = oldLose;
        
        updateDealerRuleText();
    }

    function setWinType(type) {
        currentWinType = type;
        document.querySelectorAll('.btn-type')[0].classList.toggle('active', type === 'discard');
        document.querySelectorAll('.btn-type')[1].classList.toggle('active', type === 'selfdraw');
        document.getElementById('loserContainer').style.visibility = (type === 'discard') ? 'visible' : 'hidden';
        updateDealerRuleText();
    }

    function updateDealerRuleText() {
        const txt = document.getElementById('dealerRuleText');
        const dealerExtra = 1 + (2 * lienCount);
        const dealerName = players[dealerIndex].name;
        
        let msg = "";
        if (currentWinType === 'selfdraw') {
            msg = `æç¤ºï¼šè‹¥é–’å®¶è‡ªæ‘¸ï¼Œ${dealerName} å¤šä»˜ ${dealerExtra} å°ï¼›è‹¥ ${dealerName} è‡ªæ‘¸ï¼Œä¸‰å®¶å¤šä»˜ ${dealerExtra} å°ã€‚`;
        } else {
            msg = `æç¤ºï¼šè‹¥ ${dealerName} èƒ¡ç‰Œæˆ–æ”¾æ§ï¼Œè‡ªå‹•å¤šç®— ${dealerExtra} å° (èŠ1+é€£${lienCount*2})ã€‚`;
        }
        txt.innerText = msg;
    }

    function calculateScore() {
        const base = parseInt(document.getElementById('baseValue').value) || 0;
        const taiValue = parseInt(document.getElementById('taiValue').value) || 0;
        const inputTai = parseInt(document.getElementById('taiCount').value);
        const winnerIdx = parseInt(document.getElementById('winnerSelect').value);
        
        if (isNaN(inputTai)) { alert("è«‹è¼¸å…¥å°æ•¸ï¼"); return; }

        let logMessage = "";
        let totalWinAmount = 0;
        let confirmMsg = ""; // ç”¨æ–¼å½ˆå‡ºè¦–çª—çš„è¨Šæ¯
        
        // èŠå®¶å°æ•¸ = 1 + (2 * é€£èŠæ•¸)
        const dealerExtraTai = 1 + (2 * lienCount);

        // è¨ˆç®—å–®ç­†äº¤æ˜“é‡‘é¡
        const calculatePayment = (tai, isDealerInvolved) => {
            let finalTai = isDealerInvolved ? (tai + dealerExtraTai) : tai;
            return base + (finalTai * taiValue);
        };

        if (currentWinType === 'discard') {
            // --- èƒ¡ç‰Œ (æ”¾æ§) ---
            const loserIdx = parseInt(document.getElementById('loserSelect').value);
            if (winnerIdx === loserIdx) { alert("è´å®¶èˆ‡è¼¸å®¶ä¸èƒ½åŒä¸€äºº"); return; }

            let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
            let amount = calculatePayment(inputTai, isDealerInvolved);

            // æº–å‚™ç¢ºèªè¨Šæ¯
            confirmMsg = `ã€èƒ¡ç‰Œçµç®—ã€‘\n\n`;
            confirmMsg += `è´å®¶ï¼š${players[winnerIdx].name}\n`;
            confirmMsg += `æ”¾æ§ï¼š${players[loserIdx].name}\n`;
            confirmMsg += `å°æ•¸ï¼š${inputTai} å°`;
            if (isDealerInvolved) confirmMsg += ` (+èŠé€£${lienCount} / å…±${inputTai + dealerExtraTai}å°)`;
            confirmMsg += `\n\nğŸ’° é‡‘é¡ï¼š$${amount}`;
            
            // å½ˆå‡ºç¢ºèªè¦–çª—
            if(!confirm(confirmMsg)) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            // æ›´æ–°åˆ†æ•¸
            players[winnerIdx].score += amount;
            players[loserIdx].score -= amount;

            let extraText = isDealerInvolved ? ` (å«èŠé€£${lienCount})` : "";
            logMessage = `${players[winnerIdx].name} èƒ¡ ${players[loserIdx].name} - ${inputTai}å°${extraText}: ${amount}`;

        } else {
            // --- è‡ªæ‘¸ ---
            let detailLog = [];
            
            // æº–å‚™ç¢ºèªè¨Šæ¯
            confirmMsg = `ã€è‡ªæ‘¸çµç®—ã€‘\n\n`;
            confirmMsg += `è´å®¶ï¼š${players[winnerIdx].name}\n`;
            confirmMsg += `å°æ•¸ï¼š${inputTai} å°\n\n`;

            // é å…ˆè¨ˆç®—ä»¥é¡¯ç¤ºåœ¨ç¢ºèªè¦–çª—
            let tempTotalWin = 0;
            players.forEach((p, loserIdx) => {
                if (loserIdx === winnerIdx) return;
                let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
                let amount = calculatePayment(inputTai, isDealerInvolved);
                tempTotalWin += amount;
                
                confirmMsg += `${p.name} ä»˜ï¼š$${amount}`;
                if (isDealerInvolved) confirmMsg += ` (å«èŠ)`;
                confirmMsg += `\n`;
            });
            confirmMsg += `\nğŸ’° ç¸½æ”¶ï¼š$${tempTotalWin}`;

            // å½ˆå‡ºç¢ºèªè¦–çª—
            if(!confirm(confirmMsg)) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            // ç¢ºèªå¾Œæ­£å¼åŸ·è¡Œæ‰£æ¬¾
            players.forEach((p, loserIdx) => {
                if (loserIdx === winnerIdx) return;

                let isDealerInvolved = (winnerIdx === dealerIndex || loserIdx === dealerIndex);
                let amount = calculatePayment(inputTai, isDealerInvolved);
                
                p.score -= amount;
                totalWinAmount += amount;
                
                if(isDealerInvolved) detailLog.push("èŠ");
            });

            players[winnerIdx].score += totalWinAmount;
            
            let extraText = (detailLog.length > 0) ? ` (å«èŠé€£${lienCount})` : "";
            logMessage = `${players[winnerIdx].name} è‡ªæ‘¸ ${inputTai}å°${extraText}, ç¸½æ”¶: ${totalWinAmount}`;
        }

        // è§¸è¦ºå›é¥‹ (éœ‡å‹•)
        if (navigator.vibrate) {
            navigator.vibrate(50); // éœ‡å‹• 50 æ¯«ç§’
        }

        renderPlayers();
        addLog(logMessage);
        document.getElementById('taiCount').value = '';
    }

    // Modal & Log functions
    function openModal() { document.getElementById('taiModal').style.display = "block"; }
    function closeModal() { document.getElementById('taiModal').style.display = "none"; }
    function addTaiToInput(t) { 
        let inp = document.getElementById('taiCount'); 
        inp.value = (parseInt(inp.value)||0) + t; 
    }
    function addLog(msg) {
        const list = document.getElementById('historyList');
        const item = document.createElement('li');
        item.className = 'history-item';
        item.innerHTML = `<span>${msg}</span> <span class="history-details">${new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})}</span>`;
        list.insertBefore(item, list.firstChild);
    }

    init();
</script>

</body>
</html>